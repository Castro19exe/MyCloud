<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reciclagem - My Cloud</title>
    <link rel="icon" href="{{ url_for('static', filename='img/icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lixeira.css') }}">
    <script type="module" src="{{ url_for('static', filename='js/index.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main_popups.js') }}"></script>
</head>
<body>
    <div class="container">
        <nav>
            <div class="account-dropdown" id="account-section">
                <div class="account-trigger" id="account-info">
                    <div class="avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="account-username">
                        {% if current_user.is_authenticated %}
                            {{ current_user.email.split('@')[0] }}
                        {% else %}
                            Conta
                        {% endif %}
                    </div>
                    <i class="arrow-icon" id="account-arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16px" height="16px"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </i>
                </div>
                <div class="account-menu-content" id="account-menu">
                    <ul>
                        {% if current_user.is_authenticated %}
                        <li>
                            <a href="{{ url_for('logout_page') }}" id="logout-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16px" height="16px" style="margin-right: 8px; vertical-align: middle;"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                                Terminar Sessão
                            </a>
                        </li>
                        {% else %}
                        <li><a href="{{ url_for('login_page') }}" id="login-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16px" height="16px" style="margin-right: 8px; vertical-align: middle;"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Iniciar Sessão
                        </a></li>
                        <li><a href="{{ url_for('register_page') }}" id="register-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16px" height="16px" style="margin-right: 8px; vertical-align: middle;"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" /></svg>
                            Criar Conta
                        </a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <h2>My Cloud</h2> 
            
            <a href="{{ url_for('home') }}" class="nav-link {% if request.endpoint == 'home' %}active{% endif %}">
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" fill="currentColor">
                    <path d="M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 184.4c-17-15.2-39.4-24.4-64-24.4L64 256c-24.6 0-47 9.2-64 24.4L0 96zM64 288l384 0c35.3 0 64 28.7 64 64l0 64c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64zM320 416a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm128-32a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
                </svg>
                <span>Meu Disco</span>
            </a>
            <a href="{{ url_for('compartilhados_page') }}" class="nav-link {% if request.endpoint == 'compartilhados_page' %}active{% endif %}">
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                </svg>
                <span>Compartilhados</span>
            </a>
            <a href="{{ url_for('lixeira_page') }}" class="nav-link {% if request.endpoint == 'lixeira_page' %}active{% endif %}">
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <span>Reciclagem</span>
            </a>
        </nav>
        <main>
            <div class="header-section">
                <h1>Reciclagem</h1>
                {% if trashed_files %}
                <p style="margin-top: 5px; color: #555;">Os ficheiros eliminados da reciclagem serão permanente apagados</p>
                {% else %}
                <!-- <p style="margin-top: 5px; color: #555;">A sua lixeira está vazia.</p> -->
                {% endif %}
            </div>

            <table class="file-table"> <!-- Adicionada classe aqui -->
    <thead>
        <tr>
            <th class="file-table-th-name">Nome Original</th> <!-- CLASSE ADICIONADA -->
            <th class="file-table-th-type">Tipo</th>            <!-- CLASSE ADICIONADA -->
            <th class="file-table-th-size">Tamanho</th>         <!-- CLASSE ADICIONADA -->
            <th class="file-table-th-modified">Data na reciclagem</th> <!-- CLASSE ADICIONADA -->
            <th class="file-table-th-actions">Ações</th>       <!-- CLASSE ADICIONADA -->
        </tr>
    </thead>
    <tbody id="trash-file-list">
        {% if trashed_files %}
            {% for file in trashed_files %}
            <tr>
                <td class="file-table-td-name"> <!-- CLASSE ADICIONADA -->
                    <div class="filename-wrapper"> <!-- Wrapper para ícone e nome -->
                        <span class="file-icon {{ file.icon_class }}"></span>
                        <span class="filename-text" title="{{ file.original_name_display }}"> {# Para truncamento #}
                            {{ file.original_name_display }}
                        </span>
                    </div>
                </td>
                <td class="file-table-td-type">{{ file.type }}</td>         <!-- CLASSE ADICIONADA -->
                <td class="file-table-td-size">{{ file.size }}</td>         <!-- CLASSE ADICIONADA -->
                <td class="file-table-td-modified">{{ file.modified }}</td> <!-- CLASSE ADICIONADA -->
                <td class="file-table-td-actions lixeira-table-actions">     <!-- CLASSE ADICIONADA -->
                    <button type="button" class="action-btn restore-btn" onclick="confirmRestoreFile('{{ file.name }}')">
                        <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M15.322 10.774a5.002 5.002 0 00-5.363-4.29.5.5 0 00-.253.13L6.646 9.677a.5.5 0 00.666.748l2.748-2.504a3.999 3.999 0 015.006 3.168.5.5 0 00.99.086A5.002 5.002 0 0015.322 10.774zM4.678 9.226a5.002 5.002 0 005.363 4.29.5.5 0 00.253-.13l3.06-3.06a.5.5 0 00-.666-.748L9.936 12.29a3.999 3.999 0 01-5.006-3.168.5.5 0 00-.99-.086A5.002 5.002 0 004.678 9.226z" clip-rule="evenodd" /><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12z" /></svg>
                        <span>Restaurar</span>
                    </button>
                    <button type="button" class="action-btn perm-delete-btn" onclick="confirmPermanentDelete('{{ file.name }}')">
                        <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span>Apagar Perm.</span>
                    </button>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="5" class="empty-table-message" style="text-align: center;">A sua reciclagem está vazia.</td>
            </tr>
        {% endif %}
    </tbody>
</table>
        </main>
    </div>

    <!-- Container Global para Popups -->
    <div class="popup-messages-container" id="popup-messages-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="popup-message {{ category }}">
                        <span>{{ message }}</span>
                        <button type="button" class="close-popup">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <script>
    // JavaScript para confirmação e submissão da eliminação permanente
    function confirmPermanentDelete(fullFilenameInTrash) {
        if (confirm("Tem a certeza que quer apagar permanentemente este ficheiro? Esta ação não pode ser desfeita.")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('delete_permanently_from_trash_route', full_trash_filename='PLACEHOLDER_TO_REPLACE') }}".replace('PLACEHOLDER_TO_REPLACE', encodeURIComponent(fullFilenameInTrash));
            document.body.appendChild(form);
            form.submit();
        }
    }

    // NOVA FUNÇÃO JavaScript para confirmação e submissão da restauração
    function confirmRestoreFile(fullFilenameInTrash) {
        if (confirm("Tem a certeza que quer restaurar este ficheiro da lixeira?")) {
            const form = document.createElement('form');
            form.method = 'POST';
            // A rota no Flask espera o nome completo do ficheiro na lixeira (com prefixo)
            form.action = "{{ url_for('restore_from_trash_route', full_trash_filename='PLACEHOLDER_TO_REPLACE') }}".replace('PLACEHOLDER_TO_REPLACE', encodeURIComponent(fullFilenameInTrash));
            document.body.appendChild(form);
            form.submit();
        }
    }
    </script>
</body>
</html>